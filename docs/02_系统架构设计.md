# 系统架构设计 - HTML 托管平台

## 1. 总体架构图

本系统采用经典的 Serverless 架构，以此实现低成本、高扩展性和零运维负担。

```mermaid
graph TD
    User[用户/访客]
    
    subgraph Frontend_Vercel [Next.js (Vercel)]
        UI[Web UI (Dashboard)]
        API[API Routes / Server Actions]
        Proxy[Route Handler (访问代理)]
    end
    
    subgraph Backend_Supabase [Supabase]
        Auth[Authentication]
        DB[(PostgreSQL)]
        Storage[Object Storage (S3)]
    end
    
    User -->|访问管理后台| UI
    User -->|访问托管站点| Proxy
    
    UI -->|认证 & 数据| Auth
    UI -->|读写数据| DB
    UI -->|上传文件| Storage
    
    Proxy -->|验证站点 & 获取文件路径| DB
    Proxy -->|下载 HTML 内容| Storage
```

## 2. 技术栈选型

| 模块 | 技术选型 | 选择理由 |
| :--- | :--- | :--- |
| **前端框架** | **Next.js 14+ (App Router)** | 领先的 React 框架，提供优秀的路由机制和全栈能力。 |
| **UI 组件库** | **shadcn/ui** (Tailwind CSS) | 现代化、可定制性强，代码直接拷贝到项目中，易于控制。 |
| **后端服务** | **Supabase** | 开源 Firebase 替代品，提供完整的 Auth、Database 和 Storage 服务。 |
| **数据库** | **PostgreSQL** (Supabase) | 强大的关系型数据库，支持复杂的查询和行级安全 (RLS)。 |
| **文件存储** | **Supabase Storage** | 兼容 S3 的对象存储，适合存放用户上传的 HTML 文件。 |
| **部署托管** | **Vercel** | 与 Next.js 完美集成，提供极速的全球 CDN 和 Serverless 环境。 |

## 3. 核心流程设计

### 3.1 站点访问流程 (The "Proxy" Pattern)
为了实现 `domain.com/s/user/site` 这种优雅的访问路径，并且不直接暴露存储桶的公共链接，我们设计了如下代理流程：

1. **请求到达**: 用户访问 `https://platform.com/s/username/demo-site`。
2. **Next.js 路由捕获**: `/app/s/[username]/[slug]/route.ts` 捕获该 GET 请求。
3. **元数据查询**: 
   - 路由处理程序向 Supabase 数据库查询 `po_sites` 表。
   - 条件：`user_id` (通过 username 查找) AND `slug` = 'demo-site'。
   - 获取 `site_id`。
4. **内容获取**:
   - 使用 `site_id` 构建存储路径: `sites/{user_id}/{site_id}/index.html`。
   - 通过 Supabase Storage SDK (服务端 Admin 权限) 下载文件流。
5. **响应返回**:
   - 将文件内容作为 HTTP 响应体返回。
   - 设置 `Content-Type: text/html`。
   - (可选) 设置缓存头 `Cache-Control` 以优化性能。

### 3.2 文件上传流程
1. **客户端选择文件**: 用户在仪表盘选择 `index.html`。
2. **身份验证**: 客户端 SDK 自动携带当前用户的 Session Token。
3. **直接上传**: 
   - 客户端直接调用 `supabase.storage.from('sites').upload(...)`。
   - **安全屏障**: Supabase Storage RLS 策略确保用户只能向 `{user_id}/*` 路径写入数据。
4. **数据库记录**: 上传成功后，前端调用 API 可能更新站点的 `updated_at` 时间戳（或者此步骤省略，仅作为静态资源更新）。

## 4. 目录结构规范
```
/
├── app/
│   ├── (auth)/             # 登录/注册页面组
│   ├── (dashboard)/        # 仪表盘页面组 (需主要鉴权)
│   ├── api/                # 后端 API (如需)
│   └── s/[username]/[slug]/ # 核心访问路由
├── components/             # React 组件
├── lib/
│   ├── supabase.ts         # Supabase 客户端单例
│   └── utils.ts            # 通用工具函数
├── middleware.ts           # 路由守卫 (登录态检查)
└── supabase/               # 数据库相关 (migrations, types)
```
