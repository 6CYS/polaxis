# Polaxis Database & Storage Design

## 1. 数据库设计 (PostgreSQL)

我们主要使用一张核心表 `po_sites` 来管理用户的站点元数据。用户表由 Supabase Auth 系统的 `auth.users` 自动管理。

### 1.1 `po_sites` 表结构

| 字段名 | 类型 | 描述 | 约束/备注 |
| :--- | :--- | :--- | :--- |
| **id** | `uuid` | 主键 | Default: `gen_random_uuid()` |
| **user_id** | `uuid` | 归属用户 | FK -> `auth.users.id`, Not Null |
| **name** | `text` | 站点显示名称 | Not Null |
| **slug** | `text` | URL 路径标识 | Not Null, 组合唯一索引 (user_id, slug) |
| **description** | `text` | 站点描述 | 可空 |
| **created_at** | `timestamptz`| 创建时间 | Default: `now()` |
| **updated_at** | `timestamptz`| 更新时间 | Default: `now()` |

### 1.2 索引设计
- `po_sites_user_id_idx`: 加速 "查看我的站点" 查询。
- `po_sites_slug_user_id_idx`: 加速 "访问站点" 时的路由查找 (`SELECT * FROM po_sites WHERE user_id = ? AND slug = ?`)。

### 1.3 行级安全策略 (RLS)
为了保证数据安全，必须启用 RLS (Row Level Security)。

- **SELECT (读取)**:
  - 允许 `public` (所有用户/访客) 读取 `po_sites` 表？
  - 策略：允许所有人读取，因为站点本质上是公开访问的。但如果需要私有站点，可加 `is_public` 字段控制。
  - **当前策略**: `true` (全公开读取，方便路由查询)。

- **INSERT/UPDATE/DELETE (写操作)**:
  - 仅允许用户操作**自己**的数据。
  - 策略：`auth.uid() = user_id`。

---

## 2. 存储设计 (Supabase Storage)

### 2.1 Bucket 配置
- **Bucket Name**: `sites`
- **Public**: `false` (设为私有)
  - 原因：我们希望所有的 HTML 访问都经过 Next.js 中间层（为了统计、鉴权、或自定义域名扩展），而不是直接通过 Supabase 的原始 CDN URL 访问。

### 2.2 目录路径结构
```text
sites/
  └── {user_id}/           <-- 顶层目录：用户 ID
       └── {site_id}/      <-- 二级目录：站点 ID (对应 DB 中的 po_sites.id)
            └── index.html <-- 实际文件
```
- 使用 `site_id` 而不是 `slug` 作为目录名的原因：`slug` 可能会被用户修改，而 `id` 是不可变的。修改 `slug` 不应该导致需要移动文件。

### 2.3 Storage Policies (存储安全策略)
Supabase Storage 也支持类似 RLS 的策略。

- **SELECT (下载/读取)**:
  - 仅允许持有 Service Role Key 的后端（Next.js API）读取？或者允许站点拥有者读取。
  - 策略建议：`bucket_id = 'sites' AND (auth.uid() = owner_id_in_path)`。
  - **注意**: 我们的 Next.js 访问代理会使用服务端 Admin 权限读取文件，因此这里不需要向 Public 开放读取权限。

- **INSERT/UPDATE/DELETE (上传/修改)**:
  - 仅允许用户操作自己目录下的文件。
  - 策略：`bucket_id = 'sites' AND (storage.foldername(name))[1] = auth.uid()::text`。
  - 解释：检查文件路径的第一段（`{user_id}`）是否等于当前登录用户的 ID。

---

## 3. 示例 SQL 建表脚本

```sql
-- 创建 po_sites 表
create table po_sites (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  name text not null,
  slug text not null,
  description text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- 约束：同一个用户不能有两个相同的 slug
  unique (user_id, slug)
);

-- 开启 RLS
alter table po_sites enable row level security;

-- 策略：允许所有人查看站点信息（为了路由访问）
create policy "Public sites are viewable by everyone"
  on po_sites for select
  using ( true );

-- 策略：用户仅能增删改自己的站点
create policy "Users can insert their own sites"
  on po_sites for insert
  with check ( auth.uid() = user_id );

create policy "Users can update their own sites"
  on po_sites for update
  using ( auth.uid() = user_id );

create policy "Users can delete their own sites"
  on po_sites for delete
  using ( auth.uid() = user_id );
```
